<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gekko Browser - Settings</title>
  <link rel="stylesheet" href="gkp://shared.gekko/theme-vars.css" />
  <link rel="stylesheet" href="gkp://shared.gekko/styles.css" />
  <link rel="stylesheet" href="gkp://shared.gekko/button-styles.css" />
  <link rel="stylesheet" href="gkp://shared.gekko/fontawesome/all.min.css" />
  <script src="gkp://shared.gekko/theme-utils.js"></script>
  <style>
    /* Theme select styling */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      width: 100%;
    }

    .theme-option {
      cursor: pointer;
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .theme-option:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .theme-option.active {
      border: 2px solid var(--accent-color);
    }

    .theme-preview {
      height: 120px;
      width: 100%;
      position: relative;
      padding: 12px;
    }

    .theme-browser-mock {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .theme-browser-header {
      padding: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .theme-browser-tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
    }

    .theme-browser-tab {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      height: 8px;
      width: 60px;
    }

    .theme-browser-tab.active {
      background: rgba(255, 255, 255, 0.3);
    }

    .theme-browser-content {
      flex: 1;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .theme-browser-line {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
    }

    .theme-browser-line:nth-child(2) {
      width: 70%;
    }

    .theme-info {
      padding: 12px;
      background: var(--card-background);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .theme-info i {
      width: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="internal-page">
    <div class="internal-page-header">
      <h1 class="internal-page-title">Settings</h1>
      <p class="internal-page-subtitle">Customize your Gekko Browser experience</p>
    </div>
    
    <div class="internal-page-content">
      <!-- General Settings -->
      <div class="card">
        <h2 class="card-title">General Settings</h2>
        
        <div class="settings-section">
          <div class="setting-item">
            <div>
              <div class="setting-label">Theme</div>
              <div class="setting-description">Change the appearance of Gekko Browser</div>
            </div>
            <div class="setting-control theme-options">
              <div id="theme-grid" class="theme-grid">
                <!-- Theme options will be populated dynamically -->
              </div>
            </div>
          </div>
          
          <div class="setting-item">
            <div>
              <div class="setting-label">Home Page</div>
              <div class="setting-description">Page that loads when you open a new tab or click the home button</div>
            </div>
            <div class="setting-control">
              <input type="text" id="home-page-input" class="setting-input" placeholder="Enter URL">
            </div>
          </div>
          
          <div class="setting-item">
            <div>
              <div class="setting-label">Search Engine</div>
              <div class="setting-description">Default search engine for address bar searches</div>
            </div>
            <div class="setting-control">
              <select id="search-engine-select" class="setting-select">
                <option value="https://www.google.com/search?q=">Google</option>
                <option value="https://www.bing.com/search?q=">Bing</option>
                <option value="https://duckduckgo.com/?q=">DuckDuckGo</option>
                <option value="https://search.yahoo.com/search?p=">Yahoo</option>
              </select>
            </div>
          </div>
          
          <div class="setting-item">
            <div>
              <div class="setting-label">Developer Tools</div>
              <div class="setting-description">Enable developer tools for debugging</div>
            </div>
            <div class="setting-control">
              <input type="checkbox" id="dev-tools-checkbox">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Protocol Settings -->
      <div class="card">
        <h2 class="card-title">Protocol Settings</h2>
        
        <div class="settings-section">
          <div class="setting-item">
            <div>
              <div class="setting-label">GKP and GKPS Protocols</div>
              <div class="setting-description">Learn about the Gekko Protocols</div>
            </div>
            <div class="setting-control">
              <button id="view-protocols-btn" class="setting-button">View Documentation</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Privacy Settings -->
      <div class="card">
        <h2 class="card-title">Privacy & Security</h2>
        
        <div class="settings-section">
          <div class="setting-item">
            <div>
              <div class="setting-label">Browsing History</div>
              <div class="setting-description">Clear your browsing history</div>
            </div>
            <div class="setting-control">
              <button id="clear-history-btn" class="setting-button">Clear History</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- About -->
      <div class="card">
        <h2 class="card-title">About Gekko Browser</h2>
        
        <div class="settings-section">
          <div class="setting-item">
            <div>
              <div class="setting-label">Version</div>
              <div class="setting-description" id="version-text">1.0.0</div>
            </div>
            <div class="setting-control">
              <button id="about-btn" class="setting-button">About</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Initialize theme handling
    if (typeof initThemeHandling === 'function') {
      initThemeHandling();
    }
    
    // Get settings from the API
    let settings = { theme: 'dark', homePage: '', searchEngine: 'https://www.google.com/search?q=', enableDevTools: false };
    
    try {
      if (window.api && typeof window.api.getSettings === 'function') {
        settings = window.api.getSettings();
      } else if (window.parent && window.parent.api && typeof window.parent.api.getSettings === 'function') {
        settings = window.parent.api.getSettings();
      }
    } catch (error) {
      console.error('Error getting settings:', error);
    }
    
    // Populate theme grid
    const themeGrid = document.getElementById('theme-grid');
    let themes = [
      { id: "dark", name: "Dark Theme" },
      { id: "light", name: "Light Theme" },
      { id: "purple", name: "Purple Theme" },
      { id: "blue", name: "Blue Theme" },
      { id: "red", name: "Red Theme" },
      { id: "green", name: "Green Theme" },
      { id: "monokai", name: "Monokai Theme" },
      { id: "nord", name: "Nord Theme" }
    ];
    
    try {
      if (window.api && typeof window.api.getThemes === 'function') {
        const apiThemes = window.api.getThemes();
        if (Array.isArray(apiThemes) && apiThemes.length > 0) {
          themes = apiThemes;
        }
      } else if (window.parent && window.parent.api && typeof window.parent.api.getThemes === 'function') {
        const apiThemes = window.parent.api.getThemes();
        if (Array.isArray(apiThemes) && apiThemes.length > 0) {
          themes = apiThemes;
        }
      }
    } catch (error) {
      console.error('Error getting themes:', error);
    }
    
    // Helper function to get theme colors
    function getThemePreviewColor(themeId) {
      const colors = {
        'dark': '#202124',
        'light': '#f8f9fa',
        'purple': '#20123a',
        'blue': '#0d2149',
        'red': '#3c1014',
        'green': '#0d3114',
        'monokai': '#272822',
        'nord': '#2e3440'
      };
      return colors[themeId] || colors.dark;
    }

    // Helper function to get theme icon
    function getThemeIcon(themeId) {
      const icons = {
        'dark': 'fa-moon',
        'light': 'fa-sun',
        'purple': 'fa-palette',
        'blue': 'fa-water',
        'red': 'fa-fire',
        'green': 'fa-leaf',
        'monokai': 'fa-code',
        'nord': 'fa-snowflake'
      };
      return icons[themeId] || 'fa-circle';
    }

    // Handle theme change
    function handleThemeChange(themeId) {
      console.group('Theme Change');
      console.log('Theme change requested:', themeId);
      
      if (!themeId) {
        console.error('No theme ID provided');
        console.groupEnd();
        return;
      }

      // Set theme attribute on current document
      document.documentElement.setAttribute('data-theme', themeId);
      console.log('Theme attribute set on document');

      const saveTheme = async () => {
        console.group('Save Theme');
        try {
          // Try direct API access
          if (window.api && typeof window.api.setSetting === 'function') {
            console.log('Using direct API access');
            await window.api.setSetting('theme', themeId);
            console.log('Theme saved via setSetting');
            if (typeof window.api.applyTheme === 'function') {
              const result = window.api.applyTheme(themeId);
              console.log('Theme applied via API:', result);
            }
          } 
          // Try parent window API access
          else if (window.parent && window.parent.api) {
            console.log('Using parent window API access');
            if (typeof window.parent.api.setSetting === 'function') {
              await window.parent.api.setSetting('theme', themeId);
              console.log('Theme saved via parent setSetting');
            }
            if (typeof window.parent.api.applyTheme === 'function') {
              const result = window.parent.api.applyTheme(themeId);
              console.log('Theme applied via parent API:', result);
            }
          }

          console.log('Sending postMessage for theme change');
          window.parent.postMessage({ type: 'themeChange', theme: themeId }, '*');
          
          // Save to localStorage as backup
          try {
            localStorage.setItem('gekko-theme', themeId);
            console.log('Theme saved to localStorage');
          } catch (e) {
            console.warn('Could not save theme to localStorage:', e);
          }

          console.groupEnd();
          return true;
        } catch (error) {
          console.error('Error saving theme:', error);
          console.groupEnd();
          return false;
        }
      };

      // Try to save theme with retries
      const saveWithRetry = async (retries = 3) => {
        console.group(`Save attempt (${4 - retries}/3)`);
        try {
          const success = await saveTheme();
          if (!success && retries > 0) {
            console.log(`Save failed, retrying in 500ms... (${retries} attempts left)`);
            setTimeout(() => saveWithRetry(retries - 1), 500);
          } else if (success) {
            console.log('Save successful');
          } else {
            console.error('Save failed, no more retries');
          }
        } catch (error) {
          console.error('Error in saveWithRetry:', error);
          if (retries > 0) {
            console.log(`Error occurred, retrying in 500ms... (${retries} attempts left)`);
            setTimeout(() => saveWithRetry(retries - 1), 500);
          }
        }
        console.groupEnd();
      };

      saveWithRetry();
      console.groupEnd();
    }
    
    // Create theme options
    themes.forEach(theme => {
      const themeOption = document.createElement('div');
      themeOption.className = 'theme-option';
      themeOption.setAttribute('data-theme', theme.id);
      
      const preview = document.createElement('div');
      preview.className = 'theme-preview';
      preview.style.background = getThemePreviewColor(theme.id);
      
      // Create browser mockup
      preview.innerHTML = `
        <div class="theme-browser-mock">
          <div class="theme-browser-header">
            <div class="theme-browser-tabs">
              <div class="theme-browser-tab"></div>
              <div class="theme-browser-tab active"></div>
              <div class="theme-browser-tab"></div>
            </div>
          </div>
          <div class="theme-browser-content">
            <div class="theme-browser-line"></div>
            <div class="theme-browser-line"></div>
            <div class="theme-browser-line"></div>
          </div>
        </div>
      `;
      
      const info = document.createElement('div');
      info.className = 'theme-info';
      info.innerHTML = `
        <i class="fa-solid ${getThemeIcon(theme.id)}"></i>
        <span>${theme.name}</span>
      `;
      
      themeOption.appendChild(preview);
      themeOption.appendChild(info);
      themeGrid.appendChild(themeOption);
      
      // Add click handler
      themeOption.addEventListener('click', () => {
        document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
        themeOption.classList.add('active');
        handleThemeChange(theme.id);
      });
    });

    // Mark current theme as active
    const currentTheme = settings.theme || 'dark';
    const activeThemeOption = document.querySelector(`[data-theme="${currentTheme}"]`);
    if (activeThemeOption) {
      activeThemeOption.classList.add('active');
    }

    // Set current values
    document.getElementById('home-page-input').value = settings.homePage || '';
    document.getElementById('search-engine-select').value = settings.searchEngine || 'https://www.google.com/search?q=';
    document.getElementById('dev-tools-checkbox').checked = settings.enableDevTools || false;
    
    // Home page change handler
    document.getElementById('home-page-input').addEventListener('blur', () => {
      const homePageInput = document.getElementById('home-page-input');
      try {
        if (window.api && typeof window.api.setSetting === 'function') {
          window.api.setSetting('homePage', homePageInput.value);
        } else if (window.parent && window.parent.api && typeof window.parent.api.setSetting === 'function') {
          window.parent.api.setSetting('homePage', homePageInput.value);
        }
      } catch (error) {
        console.error('Error saving home page setting:', error);
      }
    });
    
    // Search engine change handler
    document.getElementById('search-engine-select').addEventListener('change', () => {
      const searchEngineSelect = document.getElementById('search-engine-select');
      try {
        if (window.api && typeof window.api.setSetting === 'function') {
          window.api.setSetting('searchEngine', searchEngineSelect.value);
        } else if (window.parent && window.parent.api && typeof window.parent.api.setSetting === 'function') {
          window.parent.api.setSetting('searchEngine', searchEngineSelect.value);
        }
      } catch (error) {
        console.error('Error saving search engine setting:', error);
      }
    });
    
    // Developer tools change handler
    document.getElementById('dev-tools-checkbox').addEventListener('change', () => {
      const devToolsCheckbox = document.getElementById('dev-tools-checkbox');
      try {
        if (window.api && typeof window.api.setSetting === 'function') {
          window.api.setSetting('enableDevTools', devToolsCheckbox.checked);
        } else if (window.parent && window.parent.api && typeof window.parent.api.setSetting === 'function') {
          window.parent.api.setSetting('enableDevTools', devToolsCheckbox.checked);
        }
      } catch (error) {
        console.error('Error saving developer tools setting:', error);
      }
    });
    
    // View protocols documentation
    document.getElementById('view-protocols-btn').addEventListener('click', () => {
      try {
        if (window.browserAction && typeof window.browserAction.navigate === 'function') {
          window.browserAction.navigate('gkp://protocols.gekko/');
        } else {
          window.parent.postMessage({ type: 'navigate', url: 'gkp://protocols.gekko/' }, '*');
        }
      } catch (error) {
        console.error('Error navigating to protocols page:', error);
      }
    });
    
    // Clear history
    document.getElementById('clear-history-btn').addEventListener('click', () => {
      try {
        if (window.api && typeof window.api.clearHistory === 'function') {
          window.api.clearHistory();
        } else if (window.parent && window.parent.api && typeof window.parent.api.clearHistory === 'function') {
          window.parent.api.clearHistory();
        }
        alert('Browsing history cleared!');
      } catch (error) {
        console.error('Error clearing history:', error);
        alert('Error clearing browsing history. Please try again.');
      }
    });
    
    // About button
    document.getElementById('about-btn').addEventListener('click', () => {
      try {
        if (window.browserAction && typeof window.browserAction.navigate === 'function') {
          window.browserAction.navigate('gkp://about.gekko/');
        } else {
          window.parent.postMessage({ type: 'navigate', url: 'gkp://about.gekko/' }, '*');
        }
      } catch (error) {
        console.error('Error navigating to about page:', error);
      }
    });
  </script>
</body>
</html>